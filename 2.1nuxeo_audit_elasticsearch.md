# Nuxeo Audit Trails & Elasticsearch Integration

---

## ðŸ”¹ Overview
In Nuxeo, every action performed on a document (create, modify, approve, delete, etc.) generates an **event**.  
The **Audit Trail** records these events, storing the "who, what, when" of each action.  
To make audit history **fast and searchable**, Nuxeo indexes these audit entries in **Elasticsearch (ES)**.

---

## ðŸ”¹ Key Components

### 1. **Events**
- Fired whenever a user or system action occurs.
- Examples:
  - `documentCreated`
  - `documentModified`
  - `lifecycle_transitionEvent`
  - `documentMoved`

### 2. **Event Listeners**
- Special components that react to events.
- The **Audit Listener** is always active:
  - Listens for core document events.
  - Creates a `LogEntry` with details.

### 3. **LogEntry**
Each entry contains metadata about the action:
- `eventId` â†’ type of event (e.g., `documentModified`)
- `eventDate` â†’ timestamp
- `principalName` â†’ who performed the action
- `docUUID` â†’ the affected document
- `docPath`, `docType`
- Optional: `comment`, old vs. new values

### 4. **Audit Database**
- LogEntries are stored in a dedicated DB table (often `nxaudit`).
- Provides reliable persistence.

### 5. **Elasticsearch (Audit Index)**
- LogEntries are mirrored to ES as JSON.
- Indexed fields:
  - Keywords (e.g., `eventId`, `principalName`)
  - Dates (e.g., `eventDate`)
  - Text fields (e.g., comments)
- Enables **fast search, filtering, and aggregations**.

---

## ðŸ”¹ Flow: From Action to Audit

```text
USER ACTION (approve contract)
   â†“
NUXEO EVENT (lifecycle_transitionEvent)
   â†“
AUDIT LISTENER (records the event)
   â†“
LOGENTRY (stored in DB + indexed in ES)
   â†“
NXQL QUERY on LogEntry â†’ Elasticsearch answers fast
```

---

## ðŸ”¹ NXQL Examples

### All actions on one document:
```sql
SELECT * FROM LogEntry
WHERE docUUID = 'abc-123-uuid'
```

### Lifecycle transitions to 'approved':
```sql
SELECT * FROM LogEntry
WHERE eventId = 'lifecycle_transition'
  AND newLifeCycleState = 'approved'
```

### Who modified a Contract:
```sql
SELECT * FROM LogEntry
WHERE docType = 'Contract'
  AND eventId = 'documentModified'
```

### Actions by a specific user last week:
```sql
SELECT * FROM LogEntry
WHERE principalName = 'ilias'
  AND eventDate >= DATE '2025-09-10'
```

---

## ðŸ”¹ Why It Matters
- **Traceability** â†’ Know exactly who did what and when.
- **Compliance** â†’ Meet audit requirements (e.g., ISO, GDPR).
- **Debugging** â†’ Investigate errors or wrong values.
- **Analytics** â†’ Build dashboards on approvals, rejections, edits.

---

## âœ… Summary
- Nuxeo emits **events** for all actions.  
- An **Audit Listener** captures them and writes **LogEntries**.  
- LogEntries are persisted in the DB **and indexed in Elasticsearch**.  
- Developers and admins query them with **NXQL over LogEntry**.  
- This provides a **full, searchable history** of document activity.
